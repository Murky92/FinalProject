<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events - Tabletop Reserve</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="shop-styles.css">
    <!-- Load shop authentication script -->
    <script src="shop-auth.js"></script>
    <style>
        .event-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .event-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .event-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .event-date,
        .event-time {
            display: inline-flex;
            align-items: center;
            background-color: #f5f7f9;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
            color: #4a6ee0;
        }

        .event-date::before {
            content: "üìÖ";
            margin-right: 6px;
        }

        .event-time::before {
            content: "‚è∞";
            margin-right: 6px;
        }

        .event-description {
            color: #555;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .event-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .edit-btn {
            background-color: #4a6ee0;
            /* Blue background */
            color: white;
            /* White text */
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: normal;
            text-align: center;
            margin-right: 5px;
        }

        .delete-btn {
            background-color: #ff3b30;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .no-events {
            text-align: center;
            padding: 40px 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            color: #666;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* Attendance info styles */
        .event-attendance {
            background-color: #f5f7f9;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

        .event-attendance::before {
            content: "üë•";
            margin-right: 6px;
        }
        
        /* Recurrence toggle styles */
        .toggle-container {
            display: flex;
            align-items: center;
            margin-top: 8px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
            margin-right: 10px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #34c759;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .slider.round {
            border-radius: 34px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        .toggle-label {
            font-size: 14px;
        }

        /* Weekday selector */
        .weekday-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .weekday-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #f0f0f0;
            cursor: pointer;
            user-select: none;
        }

        .weekday-label:hover {
            background-color: #e0e0e0;
        }

        .weekday-label input {
            position: absolute;
            opacity: 0;
        }

        .weekday-label.selected {
            background-color: #34c759;
            color: white;
        }

        /* Recurrence options */
        #recurrence-options {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #eee;
        }

        .option-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .option-row input[type="radio"] {
            margin-right: 8px;
        }

        #end-after-option {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }

        #recurrence-count {
            width: 60px;
            margin: 0 8px;
        }

        #end-on-date-option {
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }
        
        /* Recurrence indicator styles */
        .event-recurrence {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: #e0f0ff;
            color: #4a6ee0;
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-flex;
            margin-bottom: 12px;
            font-size: 0.9rem;
        }

        .recurrence-icon {
            font-size: 1.1rem;
        }
        
        /* Dialog for recurring delete options */
        .delete-options-modal {
            display: none;
            position: fixed;
            z-index: 1050; /* Above other modals */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
        }
        
        .delete-options-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 420px;
            max-width: 90%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .delete-options-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .delete-option {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .delete-option:hover {
            background-color: #f8f8f8;
            border-color: #ccc;
        }
        
        .delete-option h4 {
            margin-top: 0;
            margin-bottom: 8px;
        }
        
        .delete-option p {
            margin: 0;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</head>

<body>
    <div id="loading-message">Verifying shop access...</div>

    <div id="shop-content" class="shop-container hidden">
        <div class="dashboard-header">
            <h1>Shop Events<span id="shop-name-header"></span></h1>
            <button onclick="window.shopAuth.logout()" class="logout-btn">Logout</button>
        </div>

        <div id="approval-banner" class="approval-banner hidden">
            <div class="approval-message">Your shop is pending approval. Some features may be limited until your shop is
                approved.</div>
        </div>

        <nav class="shop-nav">
            <ul>
                <li><a href="shophome.html">Dashboard</a></li>
                <li><a href="shop-profile.html">Shop Profile</a></li>
                <li><a href="shop-reservations.html">Reservations</a></li>
                <li><a href="shop-tables.html">Tables</a></li>
                <li><a href="shop-schedule.html">Schedule</a></li>
                <li><a href="#" class="active">Events</a></li>
                <li><a href="shop-notifications.html">Notifications</a></li>
            </ul>
        </nav>

        <div id="events-message" class="message hidden"></div>

        <div class="card">
            <div class="card-header">
                <h2>Upcoming Events</h2>
                <button onclick="showAddEventModal()" class="success-btn">+ Add Event</button>
            </div>
            <p>Manage your shop's special events, game nights, and tournaments. These will be visible to customers.</p>

            <div id="events-list" class="events-list">
                <div class="loading-message">Loading events...</div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Event Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Event</h2>
            </div>

            <form id="event-form">
                <input type="hidden" id="edit-event-id">
                <input type="hidden" id="is-recurring-child" value="false">
                <input type="hidden" id="parent-event-id" value="">

                <div class="form-group">
                    <label for="event-name">Event Name*</label>
                    <input type="text" id="event-name" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="event-date">Date*</label>
                        <input type="date" id="event-date" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="event-start-time">Start Time*</label>
                        <input type="time" id="event-start-time" required>
                    </div>

                    <div class="form-group">
                        <label for="event-end-time">End Time*</label>
                        <input type="time" id="event-end-time" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="attendance-limit">Attendance Limit*</label>
                    <input type="number" id="attendance-limit" min="1" value="20" required>
                    <small>Maximum number of attendees allowed for this event</small>
                </div>

                <div class="form-group">
                    <label for="event-description">Description</label>
                    <textarea id="event-description" placeholder="Describe the event..."></textarea>
                </div>
                
                <!-- Recurring Event Toggle -->
                <div id="recurrence-toggle-container" class="form-group">
                    <label for="event-recurring">Recurring Event</label>
                    <div class="toggle-container">
                        <label class="switch">
                            <input type="checkbox" id="event-recurring" onchange="toggleRecurrenceOptions()">
                            <span class="slider round"></span>
                        </label>
                        <span class="toggle-label">Make this a recurring event</span>
                    </div>
                </div>

                <!-- Recurrence Options (hidden by default) -->
                <div id="recurrence-options" class="hidden">
                    <div class="form-group">
                        <label for="recurrence-type">Recurrence Pattern</label>
                        <select id="recurrence-type" onchange="toggleRecurrenceTypeOptions()">
                            <option value="daily">Daily</option>
                            <option value="weekly" selected>Weekly</option>
                            <option value="monthly">Monthly</option>
                        </select>
                    </div>
                    
                    <div id="weekly-options">
                        <div class="form-group">
                            <label>Repeat on</label>
                            <div class="weekday-selector">
                                <label class="weekday-label" onclick="toggleWeekday(this, 0)">
                                    <input type="checkbox" value="0"> S
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 1)">
                                    <input type="checkbox" value="1"> M
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 2)">
                                    <input type="checkbox" value="2"> T
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 3)">
                                    <input type="checkbox" value="3"> W
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 4)">
                                    <input type="checkbox" value="4"> T
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 5)">
                                    <input type="checkbox" value="5"> F
                                </label>
                                <label class="weekday-label" onclick="toggleWeekday(this, 6)">
                                    <input type="checkbox" value="6"> S
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="monthly-options" class="hidden">
                        <div class="form-options">
                            <div class="option-row">
                                <input type="radio" name="monthly-type" id="day-of-month" value="day-of-month" checked>
                                <label for="day-of-month">On day <span id="selected-day-of-month">1</span> of the month</label>
                            </div>
                            <div class="option-row">
                                <input type="radio" name="monthly-type" id="day-of-week" value="day-of-week">
                                <label for="day-of-week">On the 
                                    <select id="month-week-number">
                                        <option value="1">first</option>
                                        <option value="2">second</option>
                                        <option value="3">third</option>
                                        <option value="4">fourth</option>
                                        <option value="5">last</option>
                                    </select>
                                    <select id="month-weekday">
                                        <option value="0">Sunday</option>
                                        <option value="1">Monday</option>
                                        <option value="2">Tuesday</option>
                                        <option value="3">Wednesday</option>
                                        <option value="4">Thursday</option>
                                        <option value="5">Friday</option>
                                        <option value="6">Saturday</option>
                                    </select>
                                    of the month
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="recurrence-end-type">End Recurrence</label>
                        <select id="recurrence-end-type" onchange="toggleEndRecurrenceOptions()">
                            <option value="after">After</option>
                            <option value="on-date">On date</option>
                            <option value="never">Never</option>
                        </select>
                        
                        <div id="end-after-option">
                            <input type="number" id="recurrence-count" min="1" max="52" value="12"> occurrences
                        </div>
                        
                        <div id="end-on-date-option" class="hidden">
                            <input type="date" id="recurrence-end-date">
                        </div>
                    </div>
                </div>

                <div class="modal-buttons">
                    <button type="button" onclick="closeModal()" class="primary-btn">Cancel</button>
                    <button type="submit" class="success-btn">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Event</h2>
            </div>

            <p>Are you sure you want to delete this event? This action cannot be undone.</p>
            <input type="hidden" id="delete-event-id">

            <div class="modal-buttons">
                <button type="button" onclick="closeModal()" class="primary-btn">Cancel</button>
                <button type="button" onclick="confirmDelete()" class="danger-btn">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Recurring Delete Options Modal -->
    <div id="delete-options-modal" class="delete-options-modal">
        <div class="delete-options-content">
            <h3 class="delete-options-title">Delete Recurring Event</h3>
            
            <div class="delete-option" onclick="deleteThisOccurrence()">
                <h4>Delete only this occurrence</h4>
                <p>Other events in this series will not be affected</p>
            </div>
            
            <div class="delete-option" onclick="deleteAllOccurrences()">
                <h4>Delete this and all future occurrences</h4>
                <p>All events in this series will be permanently deleted</p>
            </div>
            
            <div class="modal-buttons">
                <button type="button" onclick="closeDeleteOptionsModal()" class="primary-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Store shop ID after verification
        let shopId = null;
        let recurringDeleteData = null;

        // Verify shop owner access
        window.shopAuth.verifyShopOwner(function (user, shopData) {
            // Store shop ID
            shopId = shopData.id;

            // Load shop events
            loadEvents();
        });

        // Load events from Firestore
        function loadEvents() {
            if (!shopId) {
                console.error('Shop ID not available');
                return;
            }

            // Show loading message
            document.getElementById('events-list').innerHTML = '<div class="loading-message">Loading events...</div>';

            // Get current date
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            // Query Firestore for events
            window.shopAuth.db.collection('Events')
                .where('shopId', '==', shopId)
                .where('date', '>=', now)
                .orderBy('date')
                .get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        document.getElementById('events-list').innerHTML = `
                            <div class="no-events">
                                <h3>No upcoming events</h3>
                                <p>You haven't added any events yet. Click the "Add Event" button to get started.</p>
                            </div>
                        `;
                        return;
                    }

                    let eventsHtml = '';

                    querySnapshot.forEach((doc) => {
                        const event = doc.data();
                        event.id = doc.id;

                        // Format date
                        const eventDate = event.date.toDate();
                        const formattedDate = eventDate.toLocaleDateString('en-GB', {
                            weekday: 'long',
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });

                        // Attendance limit display
                        const attendanceInfo = event.attendanceLimit ?
                            `Attendance Limit: ${event.attendanceLimit} people` :
                            'No attendance limit set';
                        
                        // Recurrence info
                        let recurrenceInfo = '';
                        if (event.isRecurringParent) {
                            const pattern = event.recurrencePattern;
                            let frequencyText = '';
                            
                            if (pattern.type === 'daily') {
                                frequencyText = 'Daily';
                            } else if (pattern.type === 'weekly') {
                                frequencyText = 'Weekly';
                                
                                // Add weekday info for weekly pattern
                                if (pattern.weekdays && pattern.weekdays.length > 0) {
                                    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                                    const days = pattern.weekdays.map(d => dayNames[d]).join(', ');
                                    frequencyText += ` on ${days}`;
                                }
                            } else if (pattern.type === 'monthly') {
                                frequencyText = 'Monthly';
                                
                                if (pattern.monthlyType === 'day-of-week') {
                                    const weekNumbers = ['first', 'second', 'third', 'fourth', 'last'];
                                    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                                    frequencyText += ` on the ${weekNumbers[pattern.weekNumber-1]} ${dayNames[pattern.weekday]}`;
                                }
                            }
                            
                            recurrenceInfo = `
                                <div class="event-recurrence">
                                    <span class="recurrence-icon">üîÅ</span> 
                                    <span>${frequencyText}</span>
                                </div>
                            `;
                        } else if (event.isRecurringChild) {
                            recurrenceInfo = `
                                <div class="event-recurrence">
                                    <span class="recurrence-icon">üîÅ</span> 
                                    <span>Part of recurring series</span>
                                </div>
                            `;
                        }

                        eventsHtml += `
                            <div class="event-card">
                                <div class="event-header">
                                    <h3 class="event-title">${event.name}</h3>
                                </div>
                                <div class="event-meta">
                                    <div class="event-date">${formattedDate}</div>
                                    <div class="event-time">${event.startTime} - ${event.endTime}</div>
                                </div>
                                ${recurrenceInfo}
                                <div class="event-attendance">${attendanceInfo}</div>
                                ${event.description ? `<div class="event-description">${event.description}</div>` : ''}
                                <div class="event-buttons">
                                    <button class="edit-btn" onclick="editEvent('${event.id}')">Edit</button>
                                    <button class="delete-btn" onclick="deleteEvent('${event.id}')">Delete</button>
                                </div>
                            </div>
                        `;
                    });

                    document.getElementById('events-list').innerHTML = eventsHtml;
                })
                .catch((error) => {
                    console.error('Error loading events:', error);
                    document.getElementById('events-list').innerHTML = `
                        <div class="error-message">
                            Error loading events: ${error.message}
                        </div>
                    `;
                });
        }

        // Show add event modal
        function showAddEventModal() {
            // Reset form
            document.getElementById('event-form').reset();
            document.getElementById('edit-event-id').value = '';
            document.getElementById('is-recurring-child').value = 'false';
            document.getElementById('parent-event-id').value = '';
            document.getElementById('modal-title').textContent = 'Add New Event';
            
            // Show recurrence options
            document.getElementById('recurrence-toggle-container').style.display = 'block';

            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('event-date').value = today;

            // Set default times
            document.getElementById('event-start-time').value = '18:00';
            document.getElementById('event-end-time').value = '22:00';
            document.getElementById('attendance-limit').value = '20';
            
            // Reset recurrence options
            document.getElementById('event-recurring').checked = false;
            document.getElementById('recurrence-options').classList.add('hidden');
            resetWeekdaySelection();
            
            // Initialize recurrence options
            updateWeekdaySelection();
            toggleRecurrenceTypeOptions();
            toggleEndRecurrenceOptions();

            // Show modal
            document.getElementById('event-modal').style.display = 'block';
        }

        // Edit existing event
        function editEvent(eventId) {
            // Get event data from Firestore
            window.shopAuth.db.collection('Events').doc(eventId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const event = doc.data();

                        // Set form values
                        document.getElementById('edit-event-id').value = eventId;
                        document.getElementById('modal-title').textContent = 'Edit Event';
                        document.getElementById('event-name').value = event.name;

                        // Format date for input
                        const eventDate = event.date.toDate();
                        const formattedDate = eventDate.toISOString().split('T')[0];
                        document.getElementById('event-date').value = formattedDate;

                        // Set time values
                        document.getElementById('event-start-time').value = event.startTime;
                        document.getElementById('event-end-time').value = event.endTime;
                        document.getElementById('event-description').value = event.description || '';

                        // Set attendance limit
                        document.getElementById('attendance-limit').value = event.attendanceLimit || '20';
                        
                        // Handle recurring event editing
                        if (event.isRecurringChild) {
                            // This is a child event - hide recurrence options and store parent ID
                            document.getElementById('is-recurring-child').value = 'true';
                            document.getElementById('parent-event-id').value = event.parentEventId;
                            document.getElementById('recurrence-toggle-container').style.display = 'none';
                            document.getElementById('recurrence-options').classList.add('hidden');
                        } else {
                            // Regular or parent event
                            document.getElementById('is-recurring-child').value = 'false';
                            document.getElementById('parent-event-id').value = '';
                            document.getElementById('recurrence-toggle-container').style.display = 'block';
                            
                            // Set recurrence options (only for parent events)
                            if (event.isRecurringParent && event.recurrencePattern) {
                                document.getElementById('event-recurring').checked = true;
                                document.getElementById('recurrence-options').classList.remove('hidden');
                                
                                const pattern = event.recurrencePattern;
                                document.getElementById('recurrence-type').value = pattern.type;
                                toggleRecurrenceTypeOptions();
                                
                                if (pattern.type === 'weekly' && pattern.weekdays) {
                                    resetWeekdaySelection();
                                    pattern.weekdays.forEach(day => {
                                        const checkbox = document.querySelector(`.weekday-selector input[value="${day}"]`);
                                        if (checkbox) {
                                            checkbox.checked = true;
                                            checkbox.parentElement.classList.add('selected');
                                        }
                                    });
                                } else if (pattern.type === 'monthly') {
                                    if (pattern.monthlyType === 'day-of-month') {
                                        document.getElementById('day-of-month').checked = true;
                                        document.getElementById('selected-day-of-month').textContent = pattern.dayOfMonth;
                                    } else {
                                        document.getElementById('day-of-week').checked = true;
                                        document.getElementById('month-week-number').value = pattern.weekNumber;
                                        document.getElementById('month-weekday').value = pattern.weekday;
                                    }
                                }
                                
                                document.getElementById('recurrence-end-type').value = pattern.endType;
                                toggleEndRecurrenceOptions();
                                
                                if (pattern.endType === 'after') {
                                    document.getElementById('recurrence-count').value = pattern.count;
                                } else if (pattern.endType === 'on-date') {
                                    document.getElementById('recurrence-end-date').value = pattern.endDate;
                                }
                            } else {
                                // Not a recurring event
                                document.getElementById('event-recurring').checked = false;
                                document.getElementById('recurrence-options').classList.add('hidden');
                            }
                        }

                        // Show modal
                        document.getElementById('event-modal').style.display = 'block';
                    } else {
                        showMessage('Event not found', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Error getting event:', error);
                    showMessage('Error getting event: ' + error.message, 'error');
                });
        }

        // Delete event (show confirmation)
        function deleteEvent(eventId) {
            // First check if this is a recurring event
            window.shopAuth.db.collection('Events').doc(eventId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const event = doc.data();
                        
                        // Store data for later use
                        recurringDeleteData = {
                            eventId: eventId,
                            event: event
                        };
                        
                        // Show the correct delete dialog
                        if (event.isRecurringParent || event.isRecurringChild) {
                            // Show recurring delete options
                            document.getElementById('delete-options-modal').style.display = 'block';
                        } else {
                            // Regular event - show normal delete dialog
                            document.getElementById('delete-event-id').value = eventId;
                            document.getElementById('delete-modal').style.display = 'block';
                        }
                    } else {
                        showMessage('Event not found', 'error');
                    }
                })
                .catch((error) => {
                    console.error('Error checking event:', error);
                    showMessage('Error checking event: ' + error.message, 'error');
                });
        }
        
        // Delete just this occurrence of a recurring event
        function deleteThisOccurrence() {
            const eventId = recurringDeleteData.eventId;
            const event = recurringDeleteData.event;
            
            // Delete just this event
            window.shopAuth.db.collection('Events').doc(eventId).delete()
                .then(() => {
                    // Send cancellation notification
                    return window.shopAuth.db.collection('Notifications').add({
                        shopId: shopId,
                        shopName: window.shopAuth.getShopData().storeName || 'Shop',
                        type: 'event',
                        title: 'Event Occurrence Cancelled',
                        message: `The event "${event.name}" on ${event.date.toDate().toLocaleDateString()} has been cancelled.`,
                        target: 'all',
                        isEventCancellation: true,
                        cancelledEventId: eventId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showMessage('Event occurrence deleted', 'success');
                    closeDeleteOptionsModal();
                    loadEvents();
                })
                .catch((error) => {
                    console.error('Error deleting event:', error);
                    showMessage('Error deleting event: ' + error.message, 'error');
                });
        }
        
        // Delete all occurrences of a recurring event
        function deleteAllOccurrences() {
            const eventId = recurringDeleteData.eventId;
            const event = recurringDeleteData.event;
            
            // Determine if this is a parent or child
            let parentId = event.isRecurringParent ? eventId : event.parentEventId;
            
            // Create a batch to delete all events
            const batch = window.shopAuth.db.batch();
            
            // First get all child events
            window.shopAuth.db.collection('Events')
                .where('parentEventId', '==', parentId)
                .get()
                .then((querySnapshot) => {
                    // Add all children to the batch delete
                    querySnapshot.forEach((doc) => {
                        batch.delete(doc.ref);
                    });
                    
                    // Also delete the parent event
                    return window.shopAuth.db.collection('Events').doc(parentId).get();
                })
                .then((parentDoc) => {
                    if (parentDoc.exists) {
                        batch.delete(parentDoc.ref);
                    }
                    
                    // Commit the batch
                    return batch.commit();
                })
                .then(() => {
                    // Send cancellation notification
                    return window.shopAuth.db.collection('Notifications').add({
                        shopId: shopId,
                        shopName: window.shopAuth.getShopData().storeName || 'Shop',
                        type: 'event',
                        title: 'Recurring Event Cancelled',
                        message: `The recurring event "${event.name}" has been cancelled.`,
                        target: 'all',
                        isEventCancellation: true,
                        cancelledEventId: parentId,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                })
                .then(() => {
                    showMessage('All event occurrences deleted', 'success');
                    closeDeleteOptionsModal();
                    loadEvents();
                })
                .catch((error) => {
                    console.error('Error deleting events:', error);
                    showMessage('Error deleting events: ' + error.message, 'error');
                });
        }
        
        // Close recurring delete options modal
        function closeDeleteOptionsModal() {
            document.getElementById('delete-options-modal').style.display = 'none';
            recurringDeleteData = null;
        }

        // Confirm delete for regular (non-recurring) events
        function confirmDelete() {
            const eventId = document.getElementById('delete-event-id').value;

            window.shopAuth.db.collection('Events').doc(eventId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const eventData = doc.data();
                        const eventName = eventData.name;
                        
                        // Delete the event
                        return window.shopAuth.db.collection('Events').doc(eventId).delete()
                            .then(() => {
                                // After deleting, create a cancellation notification
                                return window.shopAuth.db.collection('Notifications').add({
                                    shopId: shopId,
                                    shopName: window.shopAuth.getShopData().storeName || 'Shop',
                                    type: 'event',
                                    title: 'Event Cancelled',
                                    message: `The event "${eventName}" has been cancelled.`,
                                    target: 'all', // Send to all users
                                    isEventCancellation: true,
                                    cancelledEventId: eventId,
                                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                            });
                    } else {
                        throw new Error('Event not found');
                    }
                })
                .then(() => {
                    showMessage('Event deleted and cancellation notification sent', 'success');
                    closeModal();
                    loadEvents();
                })
                .catch((error) => {
                    console.error('Error deleting event:', error);
                    showMessage('Error deleting event: ' + error.message, 'error');
                });
        }

        // Close modal
        function closeModal() {
            document.getElementById('event-modal').style.display = 'none';
            document.getElementById('delete-modal').style.display = 'none';
        }

        // Show message
        function showMessage(message, type) {
            const messageElement = document.getElementById('events-message');
            messageElement.textContent = message;
            messageElement.className = 'message ' + (type === 'error' ? 'error-message' : 'success-message');
            messageElement.classList.remove('hidden');

            // Hide message after 5 seconds
            setTimeout(() => {
                messageElement.classList.add('hidden');
            }, 5000);
        }
        
        // Toggle recurrence options
        function toggleRecurrenceOptions() {
            const isRecurring = document.getElementById('event-recurring').checked;
            const recurrenceOptions = document.getElementById('recurrence-options');
            
            if (isRecurring) {
                recurrenceOptions.classList.remove('hidden');
                
                // Set the date of the event to highlight the correct day of week
                updateWeekdaySelection();
            } else {
                recurrenceOptions.classList.add('hidden');
            }
        }

        // Update weekday selection based on event date
        function updateWeekdaySelection() {
            const eventDate = document.getElementById('event-date').value;
            if (!eventDate) return;
            
            const date = new Date(eventDate);
            const dayOfWeek = date.getDay(); // 0 = Sunday, 6 = Saturday
            
            // Clear all weekday selections
            resetWeekdaySelection();
            
            // Check the day of week that matches the event date
            const dayCheckbox = document.querySelector(`.weekday-selector input[value="${dayOfWeek}"]`);
            if (dayCheckbox) {
                dayCheckbox.checked = true;
                dayCheckbox.parentElement.classList.add('selected');
            }
            
            // Update the day of month for monthly recurrence
            const dayOfMonth = date.getDate();
            document.getElementById('selected-day-of-month').textContent = dayOfMonth;
            
            // Update month-week-number and month-weekday for "day of week" monthly option
            const weekNumber = Math.ceil(dayOfMonth / 7);
            document.getElementById('month-week-number').value = weekNumber > 4 ? 5 : weekNumber;
            document.getElementById('month-weekday').value = dayOfWeek;
            
            // Set end date to be 3 months from start date by default
            const endDate = new Date(date);
            endDate.setMonth(endDate.getMonth() + 3);
            document.getElementById('recurrence-end-date').valueAsDate = endDate;
        }
        
        // Reset all weekday selections
        function resetWeekdaySelection() {
            document.querySelectorAll('.weekday-selector input').forEach(checkbox => {
                checkbox.checked = false;
                checkbox.parentElement.classList.remove('selected');
            });
        }
        
        // Toggle a specific weekday
        function toggleWeekday(label, dayNumber) {
            const checkbox = label.querySelector('input');
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                label.classList.add('selected');
            } else {
                label.classList.remove('selected');
            }
        }

        // Toggle recurrence type options
        function toggleRecurrenceTypeOptions() {
            const recurrenceType = document.getElementById('recurrence-type').value;
            
            // Hide all specific options first
            document.getElementById('weekly-options').classList.add('hidden');
            document.getElementById('monthly-options').classList.add('hidden');
            
            // Show the relevant options
            if (recurrenceType === 'weekly') {
                document.getElementById('weekly-options').classList.remove('hidden');
            } else if (recurrenceType === 'monthly') {
                document.getElementById('monthly-options').classList.remove('hidden');
            }
        }

        // Toggle end recurrence options
        function toggleEndRecurrenceOptions() {
            const endType = document.getElementById('recurrence-end-type').value;
            
            document.getElementById('end-after-option').classList.add('hidden');
            document.getElementById('end-on-date-option').classList.add('hidden');
            
            if (endType === 'after') {
                document.getElementById('end-after-option').classList.remove('hidden');
            } else if (endType === 'on-date') {
                document.getElementById('end-on-date-option').classList.remove('hidden');
            }
        }

        // Get recurrence data from form
        function getRecurrenceData() {
            const isRecurring = document.getElementById('event-recurring').checked;
            
            if (!isRecurring) {
                return null;
            }
            
            const recurrenceType = document.getElementById('recurrence-type').value;
            const recurrenceData = {
                type: recurrenceType,
                endType: document.getElementById('recurrence-end-type').value
            };
            
            // Add type-specific data
            if (recurrenceType === 'weekly') {
                const weekdays = [];
                document.querySelectorAll('.weekday-selector input:checked').forEach(checkbox => {
                    weekdays.push(parseInt(checkbox.value));
                });
                recurrenceData.weekdays = weekdays.length > 0 ? weekdays : [new Date(document.getElementById('event-date').value).getDay()];
            } else if (recurrenceType === 'monthly') {
                const monthlyType = document.querySelector('input[name="monthly-type"]:checked').value;
                recurrenceData.monthlyType = monthlyType;
                
                if (monthlyType === 'day-of-month') {
                    recurrenceData.dayOfMonth = new Date(document.getElementById('event-date').value).getDate();
                } else {
                    recurrenceData.weekNumber = parseInt(document.getElementById('month-week-number').value);
                    recurrenceData.weekday = parseInt(document.getElementById('month-weekday').value);
                }
            }
            
            // Add end recurrence data
            if (recurrenceData.endType === 'after') {
                recurrenceData.count = parseInt(document.getElementById('recurrence-count').value);
            } else if (recurrenceData.endType === 'on-date') {
                recurrenceData.endDate = document.getElementById('recurrence-end-date').value;
            }
            
            return recurrenceData;
        }

        // Calculate all occurrence dates based on recurrence pattern
        function calculateOccurrences(startDate, recurrenceData) {
            if (!recurrenceData) return [startDate];
            
            const occurrences = [];
            const start = new Date(startDate);
            let currentDate = new Date(start);
            occurrences.push(currentDate.toISOString().split('T')[0]);
            
            // Determine end condition
            let maxOccurrences = 999; // Default to a high number for "never" end type
            let endDate = null;
            
            if (recurrenceData.endType === 'after') {
                maxOccurrences = recurrenceData.count;
            } else if (recurrenceData.endType === 'on-date') {
                endDate = new Date(recurrenceData.endDate);
            }
            
            // Generate occurrences based on recurrence type
            let count = 1; // Already added the first occurrence
            
            while (count < maxOccurrences) {
                let nextDate = null;
                
                if (recurrenceData.type === 'daily') {
                    nextDate = new Date(currentDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                } 
                else if (recurrenceData.type === 'weekly') {
                    // For weekly, we need to find the next day that matches the weekdays pattern
                    const weekdays = recurrenceData.weekdays;
                    let found = false;
                    
                    // Start from the day after the current date
                    nextDate = new Date(currentDate);
                    nextDate.setDate(nextDate.getDate() + 1);
                    
                    // Keep incrementing until we find a matching weekday
                    for (let i = 0; i < 7; i++) {
                        const dayOfWeek = nextDate.getDay();
                        if (weekdays.includes(dayOfWeek)) {
                            found = true;
                            break;
                        }
                        nextDate.setDate(nextDate.getDate() + 1);
                    }
                    
                    if (!found) {
                        // If no weekday was selected, default to same day next week
                        nextDate = new Date(currentDate);
                        nextDate.setDate(nextDate.getDate() + 7);
                    }
                } 
                else if (recurrenceData.type === 'monthly') {
                    if (recurrenceData.monthlyType === 'day-of-month') {
                        // Same day of the month
                        nextDate = new Date(currentDate);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else {
                        // Same nth weekday of the month
                        const weekNumber = recurrenceData.weekNumber;
                        const weekday = recurrenceData.weekday;
                        
                        // Move to next month
                        nextDate = new Date(currentDate);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                        
                        // Reset to first day of the month
                        nextDate.setDate(1);
                        
                        // Find the first occurrence of the specified weekday in the month
                        while (nextDate.getDay() !== weekday) {
                            nextDate.setDate(nextDate.getDate() + 1);
                        }
                        
                        // Adjust to the nth occurrence of that weekday
                        if (weekNumber > 1 && weekNumber < 5) {
                            nextDate.setDate(nextDate.getDate() + (7 * (weekNumber - 1)));
                        } else if (weekNumber === 5) {
                            // "Last" occurrence logic
                            // First, find the first occurrence in the month
                            const firstOccurrence = new Date(nextDate);
                            
                            // Go to first day of next month
                            nextDate.setMonth(nextDate.getMonth() + 1);
                            nextDate.setDate(1);
                            
                            // Go back to the last occurrence of the weekday in previous month
                            nextDate.setDate(nextDate.getDate() - 1);
                            while (nextDate.getDay() !== weekday) {
                                nextDate.setDate(nextDate.getDate() - 1);
                            }
                            
                            // If this gives the same result as the first occurrence,
                            // there's only one occurrence that month, so use that
                            if (nextDate.getMonth() === firstOccurrence.getMonth() &&
                                nextDate.getDate() === firstOccurrence.getDate()) {
                                nextDate = firstOccurrence;
                            }
                        }
                    }
                }
                
                // Check if we've reached the end date
                if (endDate && nextDate > endDate) {
                    break;
                }
                
                // Add this occurrence to the list
                currentDate = nextDate;
                occurrences.push(currentDate.toISOString().split('T')[0]);
                count++;
            }
            
            return occurrences;
        }

        // Handle event form submit
        document.getElementById('event-form').addEventListener('submit', function (e) {
            e.preventDefault();

            if (!shopId) {
                console.error('Shop ID not available');
                return;
            }

            // Get form values
            const eventId = document.getElementById('edit-event-id').value;
            const isRecurringChild = document.getElementById('is-recurring-child').value === 'true';
            const parentEventId = document.getElementById('parent-event-id').value;
            const eventName = document.getElementById('event-name').value;
            const eventDate = document.getElementById('event-date').value;
            const startTime = document.getElementById('event-start-time').value;
            const endTime = document.getElementById('event-end-time').value;
            const description = document.getElementById('event-description').value;
            const attendanceLimit = parseInt(document.getElementById('attendance-limit').value);
            
            // Handle different scenarios
            if (eventId && isRecurringChild) {
                // Editing a recurring child event - just update this occurrence
                const eventData = {
                    name: eventName,
                    date: firebase.firestore.Timestamp.fromDate(new Date(eventDate)),
                    startTime: startTime,
                    endTime: endTime,
                    description: description,
                    attendanceLimit: attendanceLimit,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update just this occurrence
                window.shopAuth.db.collection('Events').doc(eventId).update(eventData)
                    .then(() => {
                        showMessage('Event occurrence updated successfully', 'success');
                        closeModal();
                        loadEvents();
                    })
                    .catch((error) => {
                        console.error('Error updating event:', error);
                        showMessage('Error updating event: ' + error.message, 'error');
                    });
                
                return;
            }
            
            // Get recurrence data for new or parent events
            const isRecurring = document.getElementById('event-recurring').checked;
            const recurrenceData = isRecurring ? getRecurrenceData() : null;
            
            // Create a new recurring event series
            if (isRecurring && !eventId) {
                // Calculate all occurrence dates
                const occurrences = calculateOccurrences(eventDate, recurrenceData);
                
                // Create a batch to save all the events
                const batch = window.shopAuth.db.batch();
                
                // Create parent event ID
                const parentId = window.shopAuth.db.collection('Events').doc().id;
                
                // For each occurrence, create an event
                occurrences.forEach((occurrenceDate, index) => {
                    // Reference for this occurrence (parent for first, new ID for rest)
                    const occurrenceRef = index === 0 
                        ? window.shopAuth.db.collection('Events').doc(parentId)
                        : window.shopAuth.db.collection('Events').doc();
                    
                    // Create event data
                    const eventData = {
                        shopId: shopId,
                        name: eventName,
                        date: firebase.firestore.Timestamp.fromDate(new Date(occurrenceDate)),
                        startTime: startTime,
                        endTime: endTime,
                        description: description,
                        attendanceLimit: attendanceLimit,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // Add recurrence information
                    if (index === 0) {
                        // This is the parent event
                        eventData.isRecurringParent = true;
                        eventData.recurrencePattern = recurrenceData;
                    } else {
                        // Child event
                        eventData.isRecurringChild = true;
                        eventData.parentEventId = parentId;
                        eventData.occurrenceIndex = index;
                    }
                    
                    // Add this event to the batch
                    batch.set(occurrenceRef, eventData);
                });
                
                // Commit the batch
                batch.commit()
                    .then(() => {
                        showMessage(
                            `Recurring event created with ${occurrences.length} occurrences`, 
                            'success'
                        );
                        closeModal();
                        loadEvents();
                    })
                    .catch((error) => {
                        console.error('Error saving recurring events:', error);
                        showMessage('Error saving recurring events: ' + error.message, 'error');
                    });
            } else if (eventId && !isRecurringChild) {
                // Editing an existing parent or regular event
                const eventData = {
                    name: eventName,
                    date: firebase.firestore.Timestamp.fromDate(new Date(eventDate)),
                    startTime: startTime,
                    endTime: endTime,
                    description: description,
                    attendanceLimit: attendanceLimit,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add recurrence data if this is a recurring parent
                if (isRecurring) {
                    eventData.isRecurringParent = true;
                    eventData.recurrencePattern = recurrenceData;
                }
                
                // Update the event
                window.shopAuth.db.collection('Events').doc(eventId).update(eventData)
                    .then(() => {
                        showMessage('Event updated successfully', 'success');
                        closeModal();
                        loadEvents();
                    })
                    .catch((error) => {
                        console.error('Error updating event:', error);
                        showMessage('Error updating event: ' + error.message, 'error');
                    });
            } else {
                // Creating a new single (non-recurring) event
                const eventData = {
                    shopId: shopId,
                    name: eventName,
                    date: firebase.firestore.Timestamp.fromDate(new Date(eventDate)),
                    startTime: startTime,
                    endTime: endTime,
                    description: description,
                    attendanceLimit: attendanceLimit,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Save to Firestore
                window.shopAuth.db.collection('Events').doc().set(eventData)
                    .then(() => {
                        showMessage('Event added successfully', 'success');
                        closeModal();
                        loadEvents();
                    })
                    .catch((error) => {
                        console.error('Error saving event:', error);
                        showMessage('Error saving event: ' + error.message, 'error');
                    });
            }
        });
        
        // Set up event listeners once the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Listen for date changes to update weekday selection
            document.getElementById('event-date').addEventListener('change', updateWeekdaySelection);
            
            // Initialize recurrence options
            toggleRecurrenceTypeOptions();
            toggleEndRecurrenceOptions();
        });
    </script>
</body>
</html>